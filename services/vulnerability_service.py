from attacks.vulnerability_scan import VulnerabilityScanner
from utils.logger import Logger

class VulnerabilityService:
    def __init__(self, logger=None, html_logger=None):
        self.logger = logger or Logger(log_file="logs/scan.log")
        self.scanner = VulnerabilityScanner(logger=self.logger)
        self.html_logger = html_logger

    def scan(self, devices, ssid):
        """
        devices: list of { ip, mac, vendor, os_version }
        Returns list of { ip, os_version, vulnerabilities }
        """
        results = []
        for dev in devices:
            ip = dev["ip"]
            self.logger.log(f"[INFO] Vulnerability scan on {ip}")
            vr = self.scanner.run_scan(ip, ssid=ssid, html_logger=self.html_logger)
            if vr and vr.get("vulnerabilities"):
                results.append({
                    "ip": ip,
                    "os_version": dev["os_version"],
                    "vulnerabilities": vr["vulnerabilities"]
                })
        self.logger.log(f"[INFO] Completed vuln scans for {len(results)} host(s).")
        return results
